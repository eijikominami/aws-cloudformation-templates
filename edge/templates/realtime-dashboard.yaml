AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Description: AWSCloudFormationTemplates/static-web-hosting/realtime-dashboard creates realtime dashboards for CloudFront logs.

Metadata: 
  AWS::CloudFormation::Interface:
    ParameterGroups: 
      - Label: 
          default: 'CloudFront Realtime Dashboard Configuration'
        Parameters: 
          - SamplingRate
          - KinesisFirehoseStreamNameSuffix
          - KinesisShardCount
          - KinesisNumberOfPutRecordThreshold
      - Label: 
          default: 'ElasticSearch Configuration'
        Parameters: 
          - ElasticSearchVolumeSize
          - ElasticSearchDomainName
          - ElasticSearchInstanceType
          - ElasticSearchMasterType
          - ElasticSearchLifetime
          - ElasticSearchMasterUserName
          - ElasticSearchMasterUserPassword
          - ElasticsearchVersion
      - Label: 
          default: 'Notification Configuration'
        Parameters: 
          - SNSForAlertArn
          - SNSForDeploymentArn
      - Label: 
          default: 'Tag Configuration'
        Parameters:
          - LogicalName
          - Environment
          - TagKey
          - TagValue

Parameters: 
  ElasticSearchVolumeSize:
    Type: Number
    Default: 10
    MinValue: 10
    Description: The volume size (GB) of OpenSearch Service [required]
  ElasticSearchDomainName:
    Type: String
    Default: cloudfront-realtime-logs
    AllowedPattern: .+
    Description: The domain name of OpenSearch Service [required]
  ElasticSearchInstanceType:
    Type: String
    Default: r5.large.search
    AllowedPattern: .+
    Description: The instance type of OpenSearch Service [required]
  ElasticSearchMasterType:
    Type: String
    Default: r5.large.search
    AllowedPattern: .+
    Description: The master type of OpenSearch Service [required]
  ElasticSearchLifetime:
    Type: Number
    Default: 1
    MinValue: 0
    Description: The lifetime (hour) of OpenSearch Service [required]
  ElasticSearchMasterUserName:
    Type: String
    Default: root
    AllowedPattern: .+
    Description: The user name of OpenSearch Service [required]
  ElasticSearchMasterUserPassword:
    Type: String
    Default: Password1+
    AllowedPattern: .+
    NoEcho: true
    Description: The password of OpenSearch Service [required]
  ElasticsearchVersion:
    Type: String
    Default: OpenSearch_2.11
    AllowedPattern: .+
    Description: The version of OpenSearch Service [required]
  SamplingRate:
    Type: Number
    Default: 100
    MinValue: 1
    MaxValue: 100
    Description: The sampling rate of logs sent by CloudFront [required]
  KinesisFirehoseStreamNameSuffix:
    Type: String
    Default: default
    AllowedPattern: .+
    Description: The suffix of the Kinesis Firehose stream.
  KinesisShardCount:
    Type: Number
    Default: 1
    MinValue: 1 
    Description: The shard count of Kinesis [required]
  KinesisNumberOfPutRecordThreshold:
    Type: Number
    Default: 12000000
    MinValue: 0  
    Description: The threshold of PutRecord API calls [required]
  LogicalName:
    Type: String
    Default: RealtimeDashboard
    AllowedPattern: .+
    Description: The custom prefix name [required]
  SNSForAlertArn:
    Type: String
    Default: '' 
  SNSForDeploymentArn:
    Type: String
    Default: ''
  Environment:
    Type: String
    Default: production
    AllowedValues:
      - production
      - test
      - development
  TagKey:
    Type: String
    Default: createdby
    AllowedPattern: .+
  TagValue:
    Type: String
    Default: aws-cloudformation-templates
    AllowedPattern: .+

Conditions:
  CreateShutdownElasticSearchWorker: !Not [ !Equals [ !Ref ElasticSearchLifetime, 0] ]
  CreateSNSForAlert: !Equals [ !Ref SNSForAlertArn, '']
  CreateSNSForDeployment: !Equals [ !Ref SNSForDeploymentArn, '']
  Development: !Equals [ !Ref Environment, development]

Resources:
  # Nested Stack
  SNSForAlert:
    Condition: CreateSNSForAlert
    Type: AWS::Serverless::Application
    Properties:
      Location:
        ApplicationId: arn:aws:serverlessrepo:us-east-1:172664222583:applications/sns-topic
        SemanticVersion: 2.2.1
      NotificationARNs:
        - !If
          - CreateSNSForDeployment
          - !GetAtt SNSForDeployment.Outputs.SNSTopicArn
          - !Ref SNSForDeploymentArn
      Parameters:
        TopicName: !Sub Alert-createdby-${LogicalName}
      Tags:
        environment: !Ref Environment
        createdby: !Ref TagValue
  SNSForDeployment:
    Condition: CreateSNSForDeployment
    Type: AWS::Serverless::Application
    Properties:
      Location:
        ApplicationId: arn:aws:serverlessrepo:us-east-1:172664222583:applications/sns-topic
        SemanticVersion: 2.2.1
      Parameters:
        TopicName: !Sub Deployment-createdby-${LogicalName}
      Tags:
        environment: !Ref Environment
        createdby: !Ref TagValue
  # IAM
  IAMRoleForCloudFrontRealtimeLog:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: KinesisStreams
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - kinesis:DescribeStreamSummary
                  - kinesis:DescribeStream
                  - kinesis:PutRecord
                  - kinesis:PutRecords
                Resource:
                  - !GetAtt Kinesis.Arn
              - Effect: Allow
                Action:
                  - kms:GenerateDataKey
                Resource:
                  - !GetAtt KMSKey.Arn
      RoleName: !Sub ${LogicalName}-CloudFrontRealtimeLog-${AWS::Region}
      Tags:
        - Key: environment
          Value: !Ref Environment
        - Key: !Ref TagKey
          Value: !Ref TagValue
  IAMRoleForLambda:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Description: A role required for Lambda to access CloudFormation and CloudWatch Logs.
      ManagedPolicyArns:
          - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
          - arn:aws:iam::aws:policy/CloudWatchLambdaInsightsExecutionRolePolicy
          - arn:aws:iam::aws:policy/AmazonCodeGuruProfilerAgentAccess
      Policies:
        - PolicyName: CloudWatchLogs
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogStream
                Resource: '*'
              - Effect: Allow
                Action:
                  - logs:PutLogEvents
                Resource: '*' 
        - PolicyName: CloudFormation
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - cloudformation:DescribeStacks
                  - cloudformation:UpdateStack
                Resource: '*'
      RoleName: !Sub ${LogicalName}-LambdaForRealtimeDashboard-${AWS::Region}
      Tags:
        - Key: environment
          Value: !Ref Environment
        - Key: !Ref TagKey
          Value: !Ref TagValue
  IAMRoleForKinesisFirehose:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: firehose.amazonaws.com
            Action: sts:AssumeRole
      Description: A role required for KinesisFirehose to access Glue, S3, Lambda, CloudWatch Logs, Kinesis and KMS.
      Policies:
        - PolicyName: KinesisFirehose
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:AbortMultipartUpload
                  - s3:GetBucketLocation
                  - s3:GetObject
                  - s3:ListBucket
                  - s3:ListBucketMultipartUploads
                  - s3:PutObject
                Resource:
                  - !Sub 'arn:aws:s3:::${S3ForKinesisFirehose}'
                  - !Sub 'arn:aws:s3:::${S3ForKinesisFirehose}/*'
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:GenerateDataKey
                Resource:
                  - !GetAtt KMSKey.Arn
                Condition:
                  StringEquals:
                    'kms:ViaService': s3.region.amazonaws.com
                  StringLike:
                    'kms:EncryptionContext:aws:s3:arn': !Sub 'arn:aws:s3:::${S3ForKinesisFirehose}/*'
              - Effect: Allow
                Action:
                  - es:DescribeElasticsearchDomain
                  - es:DescribeElasticsearchDomains
                  - es:DescribeElasticsearchDomainConfig
                  - es:ESHttpPost
                  - es:ESHttpPut
                Resource:
                  - !Sub 'arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/${ElasticSearchDomainName}'
                  - !Sub 'arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/${ElasticSearchDomainName}/*'
              - Effect: Allow
                Action:
                  - es:ESHttpGet
                Resource:
                  - !Sub 'arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/${ElasticSearchDomainName}/_all/_settings'
                  - !Sub 'arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/${ElasticSearchDomainName}/_cluster/stats'
                  - !Sub 'arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/${ElasticSearchDomainName}/realtime*/_mapping/*'
                  - !Sub 'arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/${ElasticSearchDomainName}/_nodes'
                  - !Sub 'arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/${ElasticSearchDomainName}/_nodes/stats'
                  - !Sub 'arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/${ElasticSearchDomainName}/_nodes/*/stats'
                  - !Sub 'arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/${ElasticSearchDomainName}/_stats'
                  - !Sub 'arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/${ElasticSearchDomainName}/realtime*/_stats'
              - Effect: Allow
                Action:
                  - kinesis:DescribeStream
                  - kinesis:GetShardIterator
                  - kinesis:GetRecords
                  - kinesis:ListShards
                Resource: !GetAtt Kinesis.Arn
              - Effect: Allow
                Action:
                  - logs:PutLogEvents
                Resource:
                  - !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${CloudWatchLogsGroupForFirehose}:log-stream:${CloudWatchLogsStreamForFirehoseElasticSearch}'
                  - !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${CloudWatchLogsGroupForFirehose}:log-stream:${CloudWatchLogsStreamForFirehoseS3}'
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                  - lambda:GetFunctionConfiguration
                Resource:
                  - !GetAtt Lambda.Arn
              - Effect: Allow
                Action:
                  - kms:Decrypt
                Resource:
                  - !GetAtt KMSKey.Arn
                Condition:
                  StringEquals:
                    'kms:ViaService': kinesis.ap-northeast-1.amazonaws.com
                  StringLike:
                    'kms:EncryptionContext:aws:kinesis:arn': !GetAtt Kinesis.Arn
      RoleName: !Sub ${LogicalName}-Firehose-${AWS::Region}
      Tags:
        - Key: environment
          Value: !Ref Environment
        - Key: !Ref TagKey
          Value: !Ref TagValue
  # CloudFront
  CloudFrontRealtimeLogConfig:
    Type: AWS::CloudFront::RealtimeLogConfig
    Properties: 
      EndPoints: 
        - KinesisStreamConfig: 
            RoleArn: !GetAtt IAMRoleForCloudFrontRealtimeLog.Arn
            StreamArn: !GetAtt Kinesis.Arn
          StreamType: Kinesis
      Fields: 
        - timestamp
        - c-ip
        - time-to-first-byte
        - sc-status
        - sc-bytes
        - cs-method
        - cs-protocol
        - cs-host
        - cs-uri-stem
        - cs-bytes
        - x-edge-location
        - x-edge-request-id
        - x-host-header
        - time-taken
        - cs-protocol-version
        - c-ip-version
        - cs-user-agent
        - cs-referer
        - cs-cookie
        - cs-uri-query
        - x-edge-response-result-type
        - x-forwarded-for
        - ssl-protocol
        - ssl-cipher
        - x-edge-result-type
        - fle-encrypted-fields
        - fle-status
        - sc-content-type
        - sc-content-len
        - sc-range-start
        - sc-range-end
        - c-port
        - x-edge-detailed-result-type
        - c-country
        - cs-accept-encoding
        - cs-accept
        - cache-behavior-path-pattern
        - cs-headers
        - cs-header-names
        - cs-headers-count
      Name: RealtimeLogConfig
      SamplingRate: !Ref SamplingRate
  # Kinesis Data Streams
  Kinesis:
    Type: AWS::Kinesis::Stream
    Properties:
      Name: !Ref LogicalName
      RetentionPeriodHours: 24
      # Server-Side Encryption
      StreamEncryption:
        EncryptionType: KMS
        KeyId: alias/aws/kinesis
      ShardCount: !Ref KinesisShardCount
      Tags:
        - Key: environment
          Value: !Ref Environment
        - Key: !Ref TagKey
          Value: !Ref TagValue
  CloudWatchAlarmKinesis:
    Type: AWS::Serverless::Application
    Properties:
      Location:
        ApplicationId: arn:aws:serverlessrepo:us-east-1:172664222583:applications/cloudwatch-alarm-about-kinesis-data-streams
        SemanticVersion: 2.2.1
      Parameters:
        CustomAlarmName: !Ref LogicalName
        SNSTopicArn: !If
          - CreateSNSForAlert
          - !GetAtt SNSForAlert.Outputs.SNSTopicArn
          - !Ref SNSForAlertArn
        KinesisStreamName: !Ref LogicalName
        IteratorAgeMillisecondsThreshold: 30000
        # Number of Input Records (200000rps * 60sec)
        NumberOfPutRecordThreshold: !Ref KinesisNumberOfPutRecordThreshold
      NotificationARNs: 
        - !If
          - CreateSNSForDeployment
          - !GetAtt SNSForDeployment.Outputs.SNSTopicArn
          - !Ref SNSForDeploymentArn
      Tags:
        environment: !Ref Environment
        createdby: !Ref TagValue
  # Lambda
  Lambda:
    DependsOn:
      - LambdaLogGroup
    Type: AWS::Lambda::Function
    Properties:
      Architectures:
        - arm64
      Code:
        ZipFile: |
          import logging
          import base64
          import json

          logger = logging.getLogger()
          logger.setLevel(logging.INFO)

          logger.info("Loading function")

          def lambda_handler(event, context):
              output = []

              # Based on the fields chosen during the creation of the Real-time log configuration.
              # The order is important and please adjust the function if you have removed certain default fields from the configuration.
              realtimelog_fields_dict = {
                  "timestamp": "float",
                  "c-ip": "str",
                  "time-to-first-byte": "float",
                  "sc-status": "int",
                  "sc-bytes": "int",
                  "cs-method": "str",
                  "cs-protocol": "str",
                  "cs-host": "str",
                  "cs-uri-stem": "str",
                  "cs-bytes": "int",
                  "x-edge-location": "str",
                  "x-edge-request-id": "str",
                  "x-host-header": "str",
                  "time-taken": "float",
                  "cs-protocol-version": "str",
                  "c-ip-version": "str",
                  "cs-user-agent": "str",
                  "cs-referer": "str",
                  "cs-cookie": "str",
                  "cs-uri-query": "str",
                  "x-edge-response-result-type": "str",
                  "x-forwarded-for": "str",
                  "ssl-protocol": "str",
                  "ssl-cipher": "str",
                  "x-edge-result-type": "str",
                  "fle-encrypted-fields": "str",
                  "fle-status": "str",
                  "sc-content-type": "str",
                  "sc-content-len": "int",
                  "sc-range-start": "int",
                  "sc-range-end": "int",
                  "c-port": "int",
                  "x-edge-detailed-result-type": "str",
                  "c-country": "str",
                  "cs-accept-encoding": "str",
                  "cs-accept": "str",
                  "cache-behavior-path-pattern": "str",
                  "cs-headers": "str",
                  "cs-header-names": "str",
                  "cs-headers-count": "int",
                  "origin-fbl": "int",
                  "origin-lbl": "int",
                  "asn": "int"
              }

              for record in event["records"]:

                  # Extracting the record data in bytes and base64 decoding it
                  payload_in_bytes = base64.b64decode(record["data"])

                  # Converting the bytes payload to string
                  payload = "".join(map(chr, payload_in_bytes))

                  # dictionary where all the field and record value pairing will end up
                  payload_dict = {}

                  # counter to iterate over the record fields
                  counter = 0

                  # generate list from the tab-delimited log entry
                  payload_list = payload.strip().split("\t")

                  # perform the field, value pairing and any necessary type casting.
                  # possible types are: int, float and str (default)
                  for field, field_type in realtimelog_fields_dict.items():
                      # overwrite field_type if absent or '-'
                      if payload_list[counter].strip() == "-":
                          field_type = "str"
                      if field_type == "int":
                          payload_dict[field] = int(payload_list[counter].strip())
                      elif field_type == "float":
                          payload_dict[field] = float(payload_list[counter].strip())
                      else:
                          payload_dict[field] = payload_list[counter].strip()
                      counter = counter + 1

                  # JSON version of the dictionary type
                  payload_json = json.dumps(payload_dict)

                  # Preparing JSON payload to push back to Firehose
                  payload_json_ascii = payload_json.encode("ascii")
                  output_record = {
                      "recordId": record["recordId"],
                      "result": "Ok",
                      "data": base64.b64encode(payload_json_ascii).decode("utf-8"),
                  }
                  output.append(output_record)

              logger.info("Successfully processed {} records.".format(len(event["records"])))

              return {"records": output}
      Description: CloudFrontログを変換します。
      Environment:
        Variables:
          AWS_LAMBDA_EXEC_WRAPPER:  !If
            - Development
            - /opt/codeguru_profiler_lambda_exec
            - !Ref AWS::NoValue
          AWS_CODEGURU_PROFILER_TARGET_REGION: !If
            - Development
            - !Ref AWS::Region
            - !Ref AWS::NoValue
      FunctionName: realtimeLogsTransformer
      Layers:
        - !Sub arn:aws:lambda:${AWS::Region}:157417159150:layer:AWSCodeGuruProfilerPythonAgentLambdaLayer:11
      Handler: index.lambda_handler
      MemorySize: 512
      Role: !GetAtt IAMRoleForLambda.Arn
      Runtime: python3.9
      Tags:
        - Key: environment
          Value: !Ref Environment
        - Key: !Ref TagKey
          Value: !Ref TagValue
      Timeout: 60
      TracingConfig:
        Mode: Active
  LambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties: 
      LogGroupName: /aws/lambda/realtimeLogsTransformer
      RetentionInDays: 60
      Tags:
        - Key: environment
          Value: !Ref Environment
        - Key: !Ref TagKey
          Value: !Ref TagValue
  # CloudWatch Alarm for Lambda
  AlarmLambda:
    Type: AWS::Serverless::Application
    Properties:
      Location:
        ApplicationId: arn:aws:serverlessrepo:us-east-1:172664222583:applications/cloudwatch-alarm-about-lambda
        SemanticVersion: 2.2.1
      Parameters:
        CustomAlarmName: !Ref LogicalName
        SNSTopicArn: !If
          - CreateSNSForAlert
          - !GetAtt SNSForAlert.Outputs.SNSTopicArn
          - !Ref SNSForAlertArn
        MetricFilterPattern: ''
        FunctionResouceName: !Ref Lambda
      Tags:
        environment: !Ref Environment
        createdby: !Ref TagValue
  # Kinesis Firehose
  KinesisFirehose:
    Type: AWS::KinesisFirehose::DeliveryStream
    Properties:
      DeliveryStreamName: !Sub ${LogicalName}-${KinesisFirehoseStreamNameSuffix}
      DeliveryStreamType: KinesisStreamAsSource
      KinesisStreamSourceConfiguration:
        KinesisStreamARN: !GetAtt Kinesis.Arn
        RoleARN: !GetAtt IAMRoleForKinesisFirehose.Arn
      ElasticsearchDestinationConfiguration:
        BufferingHints:
          IntervalInSeconds: 60
          SizeInMBs: 1
        CloudWatchLoggingOptions: 
          Enabled: true
          LogGroupName: !Ref CloudWatchLogsGroupForFirehose
          LogStreamName: !Ref CloudWatchLogsStreamForFirehoseS3
        DomainARN: !GetAtt ElasticSearchDomain.DomainArn
        IndexName: realtime
        IndexRotationPeriod: NoRotation
        ProcessingConfiguration: 
          Enabled: true
          Processors: 
            - Parameters: 
                - ParameterName: LambdaArn
                  ParameterValue: !GetAtt Lambda.Arn
              Type: Lambda
        RetryOptions: 
          DurationInSeconds: 300
        RoleARN: !GetAtt IAMRoleForKinesisFirehose.Arn
        S3BackupMode: FailedDocumentsOnly
        S3Configuration: 
          BucketARN: !GetAtt S3ForKinesisFirehose.Arn
          CloudWatchLoggingOptions:
            Enabled: true
            LogGroupName: !Ref CloudWatchLogsGroupForFirehose
            LogStreamName: !Ref CloudWatchLogsStreamForFirehoseElasticSearch
          RoleARN: !GetAtt IAMRoleForKinesisFirehose.Arn
        # Types are deprecated in OpenSearch version 7.8.
        # TypeName must be empty. 
        TypeName: ''
  CloudWatchLogsGroupForFirehose:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupClass: INFREQUENT_ACCESS
      LogGroupName: !Sub /aws/kinesisfirehose/${LogicalName}
      RetentionInDays: 60
      Tags:
        - Key: environment
          Value: !Ref Environment
        - Key: !Ref TagKey
          Value: !Ref TagValue
  CloudWatchLogsStreamForFirehoseS3:
    Type: AWS::Logs::LogStream
    Properties:
      LogGroupName: !Ref CloudWatchLogsGroupForFirehose
      LogStreamName: S3
  CloudWatchLogsStreamForFirehoseElasticSearch:
    Type: AWS::Logs::LogStream
    Properties:
      LogGroupName: !Ref CloudWatchLogsGroupForFirehose
      LogStreamName: ElasticSearch
  CloudWatchAlarmFirehose:
    Type: AWS::Serverless::Application
    Properties:
      Location:
        ApplicationId: arn:aws:serverlessrepo:us-east-1:172664222583:applications/cloudwatch-alarm-about-kinesis-data-firehose
        SemanticVersion: 2.2.1
      Parameters:
        CustomAlarmName: !Ref LogicalName
        SNSTopicArn: !If
          - CreateSNSForAlert
          - !GetAtt SNSForAlert.Outputs.SNSTopicArn
          - !Ref SNSForAlertArn
        FirehoseStreamName: !Ref KinesisFirehose
      NotificationARNs: 
        - !If
          - CreateSNSForDeployment
          - !GetAtt SNSForDeployment.Outputs.SNSTopicArn
          - !Ref SNSForDeploymentArn
      Tags:
        environment: !Ref Environment
        createdby: !Ref TagValue
  # S3
  S3ForKinesisFirehose:
    Type: AWS::S3::Bucket
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration: 
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      BucketName: !Sub ${ElasticSearchDomainName}-${AWS::Region}-${AWS::AccountId}
      LifecycleConfiguration:
        Rules:
          - Id: ExpirationInDays
            ExpirationInDays: 60
            Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: environment
          Value: !Ref Environment
        - Key: !Ref TagKey
          Value: !Ref TagValue
  S3BucketPolicyForKinesisFirehose:
    Type: AWS::S3::BucketPolicy
    Properties: 
      Bucket: !Ref S3ForKinesisFirehose
      PolicyDocument:
        Version: 2012-10-17
        Id: !Ref S3ForKinesisFirehose
        Statement:
          - Effect: Deny
            Principal: '*'
            Action: 's3:*'
            Resource: 
              - !GetAtt S3ForKinesisFirehose.Arn
              - !Join
                - ''
                - - !GetAtt S3ForKinesisFirehose.Arn
                  - /*
            Condition:
              Bool: 
                aws:SecureTransport: false
  # KMS
  KMSKey:
    Type: AWS::KMS::Key
    Properties: 
      Description: Encrypt CloudTrail Logs
      Enabled: true
      EnableKeyRotation: true
      KeyPolicy: 
        Version: 2012-10-17
        Id: DefaultKeyPolicy
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
            Action: 'kms:*'
            Resource: '*'
          - Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action:
              - 'kms:GenerateDataKey*'
            Resource:
              - '*'
            Condition:
              StringLike:
                kms:EncryptionContext:aws:cloudtrail:arn:
                  - !Sub arn:aws:cloudtrail:*:${AWS::AccountId}:trail/*
          - Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action:
              - kms:DescribeKey
            Resource:
              - '*'
      KeyUsage: ENCRYPT_DECRYPT
      PendingWindowInDays: 30
      Tags: 
        - Key: environment
          Value: !Ref Environment
        - Key: !Ref TagKey
          Value: !Ref TagValue 
  # OpenSearch Service
  ElasticSearchDomain:
    Type: AWS::OpenSearchService::Domain
    Properties: 
      AccessPolicies:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS:
                - '*'
            Action:
              - es:*
            Resource: !Sub arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/${ElasticSearchDomainName}/*
      AdvancedSecurityOptions: 
        Enabled: true
        InternalUserDatabaseEnabled: true
        MasterUserOptions:
          MasterUserName: !Ref ElasticSearchMasterUserName
          MasterUserPassword: !Ref ElasticSearchMasterUserPassword
      DomainEndpointOptions: 
        EnforceHTTPS: true
      DomainName: !Ref ElasticSearchDomainName
      EBSOptions: 
        EBSEnabled: true
        VolumeSize: !Ref ElasticSearchVolumeSize
        VolumeType: gp3
      ClusterConfig: 
        DedicatedMasterCount: 3
        DedicatedMasterEnabled: true
        DedicatedMasterType: !Ref ElasticSearchMasterType
        InstanceCount: 3
        InstanceType: !Ref ElasticSearchInstanceType
        ZoneAwarenessConfig: 
          AvailabilityZoneCount: 3
        ZoneAwarenessEnabled: true
      EncryptionAtRestOptions:
        Enabled: true
        KmsKeyId: !GetAtt KMSKey.Arn
      EngineVersion: !Ref ElasticsearchVersion
      IPAddressType: dualstack
      NodeToNodeEncryptionOptions: 
        Enabled: true
      SnapshotOptions: 
        AutomatedSnapshotStartHour: 0
      SoftwareUpdateOptions:
        AutoSoftwareUpdateEnabled: true
      Tags: 
        - Key: environment
          Value: !Ref Environment
        - Key: !Ref TagKey
          Value: !Ref TagValue 
  CloudWatchAlarmElasticsearch:
    Type: AWS::Serverless::Application
    Properties:
      Location:
        ApplicationId: arn:aws:serverlessrepo:us-east-1:172664222583:applications/cloudwatch-alarm-about-elasticsearch
        SemanticVersion: 2.2.1
      Parameters:
        CustomAlarmName: !Ref LogicalName
        SNSTopicArn: !If
          - CreateSNSForAlert
          - !GetAtt SNSForAlert.Outputs.SNSTopicArn
          - !Ref SNSForAlertArn
        DomainName: !Ref ElasticSearchDomain
        FreeStorageSpaceThreshold: !Ref ElasticSearchVolumeSize
      NotificationARNs: 
        - !If
          - CreateSNSForDeployment
          - !GetAtt SNSForDeployment.Outputs.SNSTopicArn
          - !Ref SNSForDeploymentArn
      Tags:
        environment: !Ref Environment
        createdby: !Ref TagValue
  # EventBridge for ShutdownElasticSearchWorker
  CloudWatchEventsForShutdownElasticSearchWorker:
    Condition: CreateShutdownElasticSearchWorker
    Type: AWS::Events::Rule
    Properties: 
      Description: Shutdown retired OpenSearch Service cluster.
      Name: ShutdownElasticSearchWorker
      # Every 5 minutes
      ScheduleExpression: cron(*/5 * ? * * *)
      State: ENABLED
      Targets:
        - Arn: !GetAtt LambdaShutdownElasticSearch.Arn
          Id: ShutdownElasticSearchWorker
  AlarmEventsForShutdownElasticSearchWorker:
    Condition: CreateShutdownElasticSearchWorker
    Type: AWS::Serverless::Application
    Properties:
      Location:
        ApplicationId: arn:aws:serverlessrepo:us-east-1:172664222583:applications/cloudwatch-alarm-about-events
        SemanticVersion: 2.2.1
      NotificationARNs:
        - !If
          - CreateSNSForDeployment
          - !GetAtt SNSForDeployment.Outputs.SNSTopicArn
          - !Ref SNSForDeploymentArn
      Parameters:
        CustomAlarmName: !Ref AWS::StackName
        SNSTopicArn: !If
          - CreateSNSForAlert
          - !GetAtt SNSForAlert.Outputs.SNSTopicArn
          - !Ref SNSForAlertArn
        EventsRuleName: !Ref CloudWatchEventsForShutdownElasticSearchWorker
      Tags:
        environment: !Ref Environment
        createdby: !Ref TagValue
  # Lambda
  LambdaShutdownElasticSearch:
    Condition: CreateShutdownElasticSearchWorker
    DependsOn:
      - LambdaShutdownElasticSearchLogGroup
    Type: AWS::Lambda::Function
    Properties:
      Architectures:
        - arm64
      Code:
        ZipFile: !Sub |
          import boto3
          import logging
          import datetime
          import time

          logger = logging.getLogger()
          logger.setLevel(logging.INFO)

          cloudformation = boto3.client('cloudformation')

          def lambda_handler(event, context):
            response = cloudformation.describe_stacks(
                StackName='${LogicalName}'
            )
            last_updated_time = response['Stacks'][0]['LastUpdatedTime'].timestamp()
            parameters = response['Stacks'][0]['Parameters']

            for parameter in parameters:
              if parameter['ParameterKey'] == 'RealtimeDashboardState':
                parameter['ParameterValue'] = 'DISABLED'
            
            now = time.time()

            if now > last_updated_time + 3600*${ElasticSearchLifetime}:
              cloudformation.update_stack(
                StackName=response['Stacks'][0]['StackName'],
                UsePreviousTemplate=True,
                Parameters=parameters,
                Capabilities=['CAPABILITY_IAM','CAPABILITY_NAMED_IAM','CAPABILITY_AUTO_EXPAND']
              )
            logger.info(str(datetime))

      Description: Elasticsearchを削除します。
      Environment:
        Variables:
          AWS_LAMBDA_EXEC_WRAPPER:  !If
            - Development
            - /opt/codeguru_profiler_lambda_exec
            - !Ref AWS::NoValue
          AWS_CODEGURU_PROFILER_TARGET_REGION: !If
            - Development
            - !Ref AWS::Region
            - !Ref AWS::NoValue
      FunctionName: shutdownElasticSearch
      Handler: index.lambda_handler
      Layers:
        - !Sub arn:aws:lambda:${AWS::Region}:157417159150:layer:AWSCodeGuruProfilerPythonAgentLambdaLayer:11
      MemorySize: 128
      Role: !GetAtt IAMRoleForLambda.Arn
      Runtime: python3.9
      Tags:
        - Key: environment
          Value: !Ref Environment
        - Key: !Ref TagKey
          Value: !Ref TagValue
      Timeout: 3
      TracingConfig:
        Mode: Active
  LambdaShutdownElasticSearchPermission:
    Condition: CreateShutdownElasticSearchWorker
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref LambdaShutdownElasticSearch
      Principal: events.amazonaws.com
      # DO NOT write 'SourceAccount' option.
      SourceArn: !GetAtt CloudWatchEventsForShutdownElasticSearchWorker.Arn
  LambdaShutdownElasticSearchLogGroup:
    Condition: CreateShutdownElasticSearchWorker
    Type: AWS::Logs::LogGroup
    Properties: 
      LogGroupName: /aws/lambda/shutdownElasticSearch
      RetentionInDays: 60
      Tags: 
        - Key: !Ref TagKey
          Value: !Ref TagValue
  # CloudWatch Alarm for Lambda
  AlarmLambdaShutdownElasticSearch:
    Condition: CreateShutdownElasticSearchWorker
    Type: AWS::Serverless::Application
    Properties:
      Location:
        ApplicationId: arn:aws:serverlessrepo:us-east-1:172664222583:applications/cloudwatch-alarm-about-lambda
        SemanticVersion: 2.2.1
      Parameters:
        CustomAlarmName: !Ref LogicalName
        SNSTopicArn: !If
          - CreateSNSForAlert
          - !GetAtt SNSForAlert.Outputs.SNSTopicArn
          - !Ref SNSForAlertArn
        MetricFilterPattern: ''
        FunctionResouceName: !Ref LambdaShutdownElasticSearch
      Tags:
        environment: !Ref Environment
        createdby: !Ref TagValue
  # CloudWatch Dashboard
  Dashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Ref AWS::StackName
      DashboardBody: !Sub '{"widgets": [{"type": "text","x": 0,"y": 0,"width": 24,"height": 2,"properties": {"markdown": "\n# CloudFront Real-time Dashboard\nCloudFrontのリアルタイムログを可視化するダッシュボードのパフォーマンスを確認できます。\n"}},{"type": "metric","x": 0,"y": 2,"width": 12,"height": 6,"properties": {"metrics": [[ "AWS/Kinesis", "PutRecords.Records", "StreamName", "${Kinesis}", { "label": "Kinesis PutRecords" } ],[ ".", "GetRecords.Records", ".", ".", { "label": "Kinesis GetRecords" } ],[ "AWS/Firehose", "DataReadFromKinesisStream.Records", "DeliveryStreamName", "${KinesisFirehose}", { "label": "Firehose DataReadFromKinesisStream" } ],[ ".", "DeliveryToElasticsearch.Records", ".", ".", { "label": "Firehose DeliveryToElasticsearch" } ],[ ".", "SucceedProcessing.Records", ".", ".", { "label": "Firehose SucceedProcessing" } ]],"view": "timeSeries","stacked": false,"region": "${AWS::Region}","stat": "Sum","period": 60,"title": "Records"}},{"type": "metric","x": 12,"y": 2,"width": 12,"height": 6,"properties": {"metrics": [[ "AWS/Kinesis", "PutRecords.Latency", "StreamName", "${Kinesis}", { "label": "Kinesis PutRecords" } ],[ ".", "GetRecords.Latency", ".", ".", { "label": "Kinesis GetRecords" } ],[ "AWS/Firehose", "DescribeDeliveryStream.Latency", "DeliveryStreamName", "${KinesisFirehose}", { "label": "Firehose DescribeDeliveryStream" } ],[ "AWS/ES", "WriteLatency", "DomainName", "${ElasticSearchDomain}", "ClientId", "${AWS::AccountId}", { "label": "Elasticsearch Write" } ],[ ".", "IndexingLatency", ".", ".", ".", ".", { "label": "Elasticsearch Indexing" } ]],"view": "timeSeries","stacked": true,"region": "${AWS::Region}","stat": "Average","period": 60,"title": "Latency"}},{"type": "text","x": 0,"y": 8,"width": 12,"height": 1,"properties": {"markdown": "\n# Kinesis Data Streams\n"}},{"type": "metric","x": 0,"y": 9,"width": 12,"height": 3,"properties": {"title": "WriteProvisionedThroughputExceeded","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Warning-${LogicalName}-Kinesis-${Kinesis}-WriteProvisionedThroughputExceeded"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "metric","x": 0,"y": 12,"width": 12,"height": 3,"properties": {"title": "PutRecordSuccess","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Warning-${LogicalName}-Kinesis-${Kinesis}-PutRecord-Success-is-Too-High"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "metric","x": 0,"y": 15,"width": 12,"height": 3,"properties": {"title": "IteratorAgeMilliseconds","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Notice-${LogicalName}-Kinesis-${Kinesis}-IteratorAgeMilliseconds-is-Too-Long"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "text","x": 12,"y": 8,"width": 12,"height": 1,"properties": {"markdown": "\n# Kinesis Data Firehose\n"}},{"type": "metric","x": 12,"y": 9,"width": 12,"height": 3,"properties": {"title": "ThrottledGetShardIterator","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Warning-${LogicalName}-Firehose-${KinesisFirehose}-Throttled-Get-Shard-Iterator"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "metric","x": 0,"y": 18,"width": 12,"height": 3,"properties": {"title": "DeliveryToS3Success","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Warning-${LogicalName}-Firehose-${KinesisFirehose}-Delivery-To-S3-Failed"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "metric","x": 12,"y": 15,"width": 12,"height": 3,"properties": {"title": "DeliveryToElasticsearchDataFreshness","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Notice-${LogicalName}-Firehose-${KinesisFirehose}-Delivery-To-Elasticsearch-Data-Freshness"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "metric","x": 12,"y": 12,"width": 12,"height": 3,"properties": {"title": "ThrottledGetRecords","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Warning-${LogicalName}-Firehose-${KinesisFirehose}-Throttled-Get-Records"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "metric","x": 12,"y": 18,"width": 12,"height": 3,"properties": {"title": "DeliveryToElasticsearchSuccess","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Warning-${LogicalName}-Firehose-${KinesisFirehose}-Delivery-To-Elasticsearch-Failed"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "text","x": 0,"y": 21,"width": 24,"height": 1,"properties": {"markdown": "\n# Lambda\n"}},{"type": "metric","x": 0,"y": 22,"width": 6,"height": 3,"properties": {"title": "TypeError","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Warning-${LogicalName}-Lambda-${Lambda}-TypeError"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "metric","x": 12,"y": 25,"width": 12,"height": 3,"properties": {"title": "Duration","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Warning-${LogicalName}-Lambda-${Lambda}-Timeout-Will-Occur"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "metric","x": 6,"y": 22,"width": 6,"height": 3,"properties": {"title": "ClientError","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Warning-${LogicalName}-Lambda-${Lambda}-ClientError"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "metric","x": 12,"y": 22,"width": 6,"height": 3,"properties": {"title": "Errors","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Warning-${LogicalName}-Lambda-${Lambda}-Errors"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "metric","x": 0,"y": 25,"width": 12,"height": 3,"properties": {"title": "Throttles","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Warning-${LogicalName}-Lambda-${Lambda}-Throttles"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "metric","x": 18,"y": 22,"width": 6,"height": 3,"properties": {"title": "ErrorLog","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Warning-${LogicalName}-Lambda-${Lambda}-ErrorLog"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "text","x": 0,"y": 28,"width": 24,"height": 1,"properties": {"markdown": "\n# OpenSearch Service\n"}},{"type": "metric","x": 0,"y": 32,"width": 12,"height": 3,"properties": {"title": "MasterReachableFromNode","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Warning-${LogicalName}-Elasticsearch-${ElasticSearchDomain}-Master-Reachable-From-Node"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "metric","x": 12,"y": 32,"width": 12,"height": 3,"properties": {"title": "AutomatedSnapshotFailure","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Notice-${LogicalName}-Elasticsearch-${ElasticSearchDomain}-Automated-Snapshot-Failure"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "metric","x": 12,"y": 35,"width": 12,"height": 3,"properties": {"title": "MasterJVMMemoryPressure","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Notice-${LogicalName}-Elasticsearch-${ElasticSearchDomain}-Master-JVM-Memory-Pressure"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "metric","x": 0,"y": 29,"width": 12,"height": 3,"properties": {"title": "ClusterStatus","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Warning-${LogicalName}-Elasticsearch-${ElasticSearchDomain}-Cluster-Status"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "metric","x": 0,"y": 38,"width": 12,"height": 3,"properties": {"title": "KibanaHealthyNodes","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Warning-${LogicalName}-Elasticsearch-${ElasticSearchDomain}-Kibana-Healthy-Nodes"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "metric","x": 12,"y": 29,"width": 12,"height": 3,"properties": {"title": "ClusterIndexWritesBlocked","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Notice-${LogicalName}-Elasticsearch-${ElasticSearchDomain}-Cluster-Index-Writes-Blocked"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "metric","x": 0,"y": 35,"width": 12,"height": 3,"properties": {"title": "MasterCPUUtilization","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Notice-${LogicalName}-Elasticsearch-${ElasticSearchDomain}-Master-CPU-Utilization"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "metric","x": 12,"y": 38,"width": 12,"height": 3,"properties": {"title": "FreeStorageSpace","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Warning-${LogicalName}-Elasticsearch-${ElasticSearchDomain}-Free-Storage-Space"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "metric","x": 0,"y": 41,"width": 12,"height": 3,"properties": {"title": "DataCPUUtilization","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Notice-${LogicalName}-Elasticsearch-${ElasticSearchDomain}-Data-CPU-Utilization"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "metric","x": 12,"y": 41,"width": 12,"height": 3,"properties": {"title": "DataJVMMemoryPressure","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Notice-${LogicalName}-Elasticsearch-${ElasticSearchDomain}-Data-JVM-Memory-Pressure"]},"view": "timeSeries","stacked": false,"type": "chart"}},{"type": "metric","x": 0,"y": 44,"width": 12,"height": 3,"properties": {"title": "DataSysMemoryUtilization","annotations": {"alarms": ["arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:Notice-${LogicalName}-Elasticsearch-${ElasticSearchDomain}-Data-Sys-Memory-Utilization"]},"view": "timeSeries","stacked": false,"type": "chart"}}]}'

Outputs:
  IAMRoleForKinesisFirehoseArn:
    Description: The ARN of IAM Role for Kinesis Firehose
    Value: !GetAtt IAMRoleForKinesisFirehose.Arn
  KibanaURL:
    Description: Kibana URL
    Value: !Join
      - ''
      - - !GetAtt ElasticSearchDomain.DomainEndpoint
        - /_plugin/kibana/
  RealtimeLogConfigArn:
    Description: The ARN of Realtime Log Config
    Value: !GetAtt CloudFrontRealtimeLogConfig.Arn