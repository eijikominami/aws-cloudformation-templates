AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Description: AWSCloudFormationTemplates/static-web-hosting/realtime-dashboard creates realtime dashboards for CloudFront logs.

Parameters: 
  LogicalNamePrefix:
    Type: String
    Default: DefaultSecuritySettings
    AllowedPattern: .+
    Description: The custom prefix name [required]
  SamplingRate:
    Type: Number
    Default: 100
    MinValue: 1
    MaxValue: 100
  ShardCount:
    Type: Number
    Default: 1
    MinValue: 1 
  SNSForAlertArn:
    Type: String
    Default: '' 
  TagKey:
    Type: String
    Default: createdby
    AllowedPattern: .+
  TagValue:
    Type: String
    Default: aws:cloudformation:stack
    AllowedPattern: .+

Resources:
  # IAM
  IAMRoleForCloudFrontRealtimeLog:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: !Sub '${LogicalNamePrefix}-S3Replication-${AWS::Region}'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'kinesis:DescribeStreamSummary'
                  - 'kinesis:DescribeStream'
                  - 'kinesis:PutRecord'
                  - 'kinesis:PutRecords'
                Resource:
                  - !GetAtt Kinesis.Arn
      RoleName: !Sub '${LogicalNamePrefix}-CloudFrontRealtimeLog-${AWS::Region}'
      Tags:
        - Key: !Ref TagKey
          Value: !Ref TagValue
  # CloudFront
  CloudFormationRealtimeLogConfig:
    Type: 'AWS::CloudFront::RealtimeLogConfig'
    Properties: 
      EndPoints: 
        - KinesisStreamConfig: 
            RoleArn: !GetAtt IAMRoleForCloudFrontRealtimeLog.Arn
            StreamArn: !GetAtt Kinesis.Arn
          StreamType: Kinesis
      Fields: 
        - timestamp
        - c-ip
        - time-to-first-byte
        - sc-status
        - sc-bytes
        - cs-method
        - cs-protocol
        - cs-host
        - cs-uri-stem
        - cs-bytes
        - x-edge-location
        - x-edge-request-id
        - x-host-header
        - time-taken
        - cs-protocol-version
        - c-ip-version
        - cs-user-agent
        - cs-referer
        - cs-cookie
        - cs-uri-query
        - x-edge-response-result-type
        - x-forwarded-for
        - ssl-protocol
        - ssl-cipher
        - x-edge-result-type
        - fle-encrypted-fields
        - fle-status
        - sc-content-type
        - sc-content-len
        - sc-range-start
        - sc-range-end
        - c-port
        - x-edge-detailed-result-type
        - c-country
        - cs-accept-encoding
        - cs-accept
        - cache-behavior-path-pattern
        - cs-headers
        - cs-header-names
        - cs-headers-count
      Name: RealtimeLogConfig
      SamplingRate: !Ref SamplingRate
  # Kinesis Data Streams
  Kinesis:
    Type: 'AWS::Kinesis::Stream'
    Properties:
      Name: !Ref LogicalNamePrefix
      RetentionPeriodHours: 24
      # Server-Side Encryption
      StreamEncryption:
        EncryptionType: KMS
        KeyId: alias/aws/kinesis
      ShardCount: !Ref ShardCount
      Tags:
        - Key: !Ref TagKey
          Value: !Ref TagValue
  CloudWatchAlarmKinesis:
    Type: 'AWS::Serverless::Application'
    Properties:
      Parameters:
        CustomAlarmName: !Ref LogicalNamePrefix
        SNSTopicArn: !Ref SNSForAlertArn
        KinesisStreamName: !Ref LogicalNamePrefix
        IteratorAgeMillisecondsThreshold: 30000
        # Number of Input Records (200000rps * 60sec)
        NumberOfPutRecordThreshold: 12000000
      NotificationARNs: 
        - !Ref SNSForAlertArn
      Location:
        ApplicationId: arn:aws:serverlessrepo:us-east-1:172664222583:applications/cloudwatch-alarm-about-kinesis-data-streams
        SemanticVersion: 1.1.8
      Tags:
        createdby: !Ref TagValue
Outputs:
  RealtimeLogConfigArn:
    Description: Realtime Log Config ARN
    Value: !GetAtt CloudFormationRealtimeLogConfig.Arn